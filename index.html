<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no, maximum-scale=1.0">
<title>I Love The Zou</title>

<!-- Favicon: heart SVG -->
<link rel="icon" type="image/svg+xml" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'><text y='80' font-size='80'>‚ù§Ô∏è</text></svg>">
<link rel="apple-touch-icon" href="og-image.png">

<!-- Social / Open Graph -->
<meta property="og:title" content="I Love The Zou">
<meta property="og:description" content="A Valentine's Day Game ‚Äî Catch Zouzou! üíï">
<meta property="og:image" content="https://ilovethezou.com/og-image.png">
<meta property="og:image:width" content="1200">
<meta property="og:image:height" content="630">
<meta property="og:url" content="https://ilovethezou.com">
<meta property="og:type" content="website">
<meta name="twitter:card" content="summary_large_image">
<meta name="twitter:title" content="I Love The Zou">
<meta name="twitter:description" content="A Valentine's Day Game ‚Äî Catch Zouzou! üíï">
<meta name="twitter:image" content="https://ilovethezou.com/og-image.png">
<meta name="description" content="A Valentine's Day Game ‚Äî Catch Zouzou! üíï">
<meta name="theme-color" content="#1a0a1e">

<style>
  * { margin: 0; padding: 0; box-sizing: border-box; }
  body {
    overflow: hidden;
    background: #1a0a1e;
    font-family: 'Georgia', serif;
    touch-action: none;
    -webkit-user-select: none;
    user-select: none;
  }
  #landing {
    position: fixed; inset: 0;
    display: flex; flex-direction: column;
    align-items: center; justify-content: center;
    background: linear-gradient(135deg, #1a0a1e 0%, #2d1b35 50%, #1a0a1e 100%);
    z-index: 10;
    transition: opacity 0.6s ease;
  }
  #landing.hidden { opacity: 0; pointer-events: none; }
  #landing h1 {
    font-size: clamp(2rem, 8vw, 4rem);
    color: #ff6b8a;
    text-shadow: 0 0 30px rgba(255,107,138,0.5), 0 0 60px rgba(255,107,138,0.2);
    margin-bottom: 0.3rem;
    letter-spacing: 2px;
  }
  #landing .subtitle {
    color: #ffb3c6;
    font-size: clamp(0.9rem, 3vw, 1.3rem);
    margin-bottom: 2.5rem;
    font-style: italic; opacity: 0.8;
  }
  #landing .heart-icon {
    font-size: clamp(2rem, 6vw, 3.5rem);
    margin-bottom: 1rem;
    color: #ff4d6d;
    text-shadow: 0 0 20px rgba(255,77,109,0.6);
    animation: pulse 1.5s ease-in-out infinite;
  }
  .btn {
    padding: 15px 50px;
    font-size: clamp(1rem, 3vw, 1.3rem);
    background: linear-gradient(135deg, #ff6b8a, #ff4d6d);
    color: white; border: none; border-radius: 50px;
    cursor: pointer; font-family: inherit;
    box-shadow: 0 4px 20px rgba(255,77,109,0.4);
    transition: transform 0.2s, box-shadow 0.2s;
    letter-spacing: 1px;
  }
  .btn:hover { transform: scale(1.05); box-shadow: 0 6px 25px rgba(255,77,109,0.6); }
  .btn:active { transform: scale(0.98); }
  #gameCanvas { display: none; position: fixed; inset: 0; }
  #instructions {
    display: none; position: fixed; bottom: 15px;
    left: 50%; transform: translateX(-50%);
    color: rgba(255,179,198,0.5); font-size: 0.8rem;
    z-index: 5; text-align: center; pointer-events: none;
    transition: opacity 2s ease;
  }
  #catchOverlay {
    position: fixed; inset: 0;
    display: none; flex-direction: column;
    align-items: center; justify-content: center;
    background: rgba(26,10,30,0.92);
    z-index: 20; opacity: 0;
    transition: opacity 0.8s ease;
  }
  #catchOverlay.visible { opacity: 1; }
  #catchOverlay h2 {
    font-size: clamp(1.8rem, 7vw, 3rem);
    color: #ff6b8a;
    text-shadow: 0 0 40px rgba(255,107,138,0.8), 0 0 80px rgba(255,107,138,0.3);
    margin-bottom: 0.5rem;
    animation: pulse 1.5s ease-in-out infinite;
  }
  #catchOverlay .timer-text {
    color: #ffb3c6; font-size: 1rem;
    margin-bottom: 1.5rem; opacity: 0.7;
  }
  #catchOverlay canvas { margin-bottom: 1rem; }
  #valentineWrap {
    position: relative;
    margin-bottom: 0.5rem;
  }
  #valentineText {
    font-size: clamp(2.2rem, 9vw, 4.5rem);
    color: #fff;
    text-shadow: 0 0 30px rgba(255,77,109,0.9), 0 0 60px rgba(255,107,138,0.5), 0 0 100px rgba(255,77,109,0.3);
    letter-spacing: 2px;
    animation: valentinePop 0.6s cubic-bezier(0.17,0.67,0.35,1.5) both;
    animation-delay: 0.3s;
    opacity: 0;
  }
  @keyframes valentinePop {
    0% { transform: scale(0.3); opacity: 0; }
    100% { transform: scale(1); opacity: 1; }
  }
  #heartBurst {
    position: absolute;
    inset: 0;
    pointer-events: none;
    overflow: visible;
  }
  .burst-heart {
    position: absolute;
    left: 50%; top: 50%;
    font-size: 1.2rem;
    animation: burstOut ease-out forwards;
    pointer-events: none;
  }
  @keyframes burstOut {
    0% { transform: translate(-50%,-50%) scale(0.3) rotate(0deg); opacity: 1; }
    20% { opacity: 1; transform: translate(calc(-50% + var(--tx) * 0.3), calc(-50% + var(--ty) * 0.3)) scale(1.2) rotate(30deg); }
    100% { transform: translate(calc(-50% + var(--tx)), calc(-50% + var(--ty))) scale(0.4) rotate(180deg); opacity: 0; }
  }
  .hearts-bg {
    position: fixed; inset: 0; pointer-events: none;
    overflow: hidden; z-index: 1;
  }
  .heart-float {
    position: absolute; bottom: -30px;
    color: rgba(255,107,138,0.12);
    animation: floatUp linear infinite;
  }
  @keyframes floatUp {
    0% { transform: translateY(0) rotate(0deg); opacity: 0; }
    5% { opacity: 1; } 95% { opacity: 1; }
    100% { transform: translateY(-110vh) rotate(360deg); opacity: 0; }
  }
  @keyframes pulse {
    0%, 100% { transform: scale(1); }
    50% { transform: scale(1.1); }
  }
</style>
</head>
<body>
<div class="hearts-bg" id="heartsBg"></div>
<div id="landing">
  <div class="heart-icon">&#10084;</div>
  <h1>I Love The Zou</h1>
  <p class="subtitle">A Valentine's Day Game</p>
  <button class="btn" id="playBtn">Catch Zouzou!</button>
</div>
<canvas id="gameCanvas"></canvas>
<div id="instructions">WASD or Arrow Keys to move ¬∑ Hold Space to sprint</div>
<div id="catchOverlay">
  <canvas id="catchCanvas" width="360" height="300"></canvas>
  <h2>I Love You my Zouzou!</h2>
  <div id="valentineWrap">
    <h1 id="valentineText">Happy Valentine's!</h1>
    <div id="heartBurst"></div>
  </div>
  <p class="timer-text" id="timerText"></p>
  <button class="btn" id="replayBtn">Play Again</button>
</div>

<script>
// ============================================================
// CONSTANTS
// ============================================================
const PLAYER_SPEED = 210;
const SPRINT_MULT = 1.5;
const BOT_SPEED = 140;
const CATCH_DIST = 42;
const OL = '#1a1215'; // outline color

// ============================================================
// STATE
// ============================================================
let canvas, ctx, catchCanvas, catchCtx;
let W, H;
let gameState = 'landing';
let gameTime = 0;
let frameCount = 0;
let keys = {};
let touchDir = { x: 0, y: 0 };
let touchActive = false;
let touchStartX = 0, touchStartY = 0;
let lastTapTime = 0;
let touchSprinting = false;

const player = { x: 0, y: 0, vx: 0, vy: 0, facing: 1, moving: false, sprinting: false };
const bot = { x: 0, y: 0, vx: 0, vy: 0, facing: -1, moving: false, changeTimer: 0, pauseTimer: 0, paused: false };
let hearts = [];
let bgHearts = [];
let lastTime = 0;

// ============================================================
// FACE SPRITE LOADING
// ============================================================
let loulouFaceLoaded = false, zouzouFaceLoaded = false;
const loulouFaceImg = new Image();
const zouzouFaceImg = new Image();
loulouFaceImg.onload = () => { loulouFaceLoaded = true; };
zouzouFaceImg.onload = () => { zouzouFaceLoaded = true; };
loulouFaceImg.src = 'loulou.png';
zouzouFaceImg.src = 'zouzou.png';

// ============================================================
// DRAWING HELPERS
// ============================================================
function rr(c, x, y, w, h, radii) {
  if (typeof radii === 'number') radii = [radii, radii, radii, radii];
  const [tl, tr, br, bl] = radii;
  c.moveTo(x + tl, y);
  c.lineTo(x + w - tr, y);
  c.arcTo(x + w, y, x + w, y + tr, tr);
  c.lineTo(x + w, y + h - br);
  c.arcTo(x + w, y + h, x + w - br, y + h, br);
  c.lineTo(x + bl, y + h);
  c.arcTo(x, y + h, x, y + h - bl, bl);
  c.lineTo(x, y + tl);
  c.arcTo(x, y, x + tl, y, tl);
  c.closePath();
}

function fillShape(c, color) {
  c.fillStyle = color;
  c.fill();
  c.strokeStyle = OL;
  c.lineWidth = 2.5;
  c.lineJoin = 'round';
  c.stroke();
}

function fillOnly(c, color) {
  c.fillStyle = color;
  c.fill();
}

// ============================================================
// DRAW FACE HELPER
// ============================================================
function drawFace(c, img, loaded, bodyY, faceW, overlap, offX, offY) {
  if (!loaded) return;
  const fw = faceW;
  const fh = fw * (img.naturalHeight / img.naturalWidth);
  const fx = -fw / 2 + (offX || 0);
  const fy = bodyY + overlap - fh + (offY || 0);
  c.imageSmoothingEnabled = true;
  c.imageSmoothingQuality = 'high';
  c.drawImage(img, 0, 0, img.naturalWidth, img.naturalHeight, fx, fy, fw, fh);
}

// ============================================================
// SHARED BODY DRAWING (pixel-art style with smooth animation)
// ============================================================
function drawBody(c, frame, pose, isSprinting, colors) {
  // colors: { shirt, shirtHi, shirtLo, pants, pantsHi, shoes, skin, neckW }
  const isRun = pose === 'run';
  const isHug = pose === 'hug';
  const t = frame * (isSprinting ? 0.55 : 0.4); // animation speed
  const bounce = isRun ? Math.abs(Math.sin(t)) * 3 : 0;
  const lean = isRun ? (isSprinting ? 3 : 1.5) : 0; // forward lean when running

  // Smooth sinusoidal leg cycle
  const legCycle = isRun ? Math.sin(t) : 0;
  const legL = legCycle * (isSprinting ? 8 : 6);   // left leg offset
  const legR = -legL;                                // right leg opposite

  // Arm swing (opposite to legs)
  const armSwing = isRun ? Math.sin(t) * (isSprinting ? 6 : 4) : 0;

  // --- LEGS ---
  const legW = 11, legH = 18, legGap = 3;

  // Left leg
  c.save();
  c.translate(-legGap - legW/2, 0);
  c.rotate(legL * 0.03);
  c.beginPath(); rr(c, -legW/2, -legH + legL * 0.5, legW, legH, [3,3,4,4]); fillShape(c, colors.pants);
  // Knee highlight
  c.beginPath(); rr(c, -legW/2+2, -legH + legL*0.5 + legH*0.4, legW-4, 4, 2); fillOnly(c, colors.pantsHi);
  // Shoe
  c.beginPath(); rr(c, -legW/2 - 1, legL*0.5 - 2, legW + 3, 7, [2,2,5,5]); fillShape(c, colors.shoes);
  c.restore();

  // Right leg
  c.save();
  c.translate(legGap + legW/2, 0);
  c.rotate(legR * 0.03);
  c.beginPath(); rr(c, -legW/2, -legH + legR * 0.5, legW, legH, [3,3,4,4]); fillShape(c, colors.pants);
  c.beginPath(); rr(c, -legW/2+2, -legH + legR*0.5 + legH*0.4, legW-4, 4, 2); fillOnly(c, colors.pantsHi);
  c.beginPath(); rr(c, -legW/2 - 1, legR*0.5 - 2, legW + 3, 7, [2,2,5,5]); fillShape(c, colors.shoes);
  c.restore();

  // --- TORSO ---
  const bodyW = 34, bodyH = 26;
  const bodyY = -legH - bodyH + 8 + bounce;

  c.save();
  c.translate(lean, 0); // lean forward when running

  // Torso
  c.beginPath(); rr(c, -bodyW/2, bodyY, bodyW, bodyH, [7,7,5,5]); fillShape(c, colors.shirt);
  // Shoulder highlights
  c.beginPath(); rr(c, -bodyW/2+3, bodyY+2, bodyW-6, 6, 4); fillOnly(c, colors.shirtHi);
  // Bottom shadow
  c.beginPath(); rr(c, -bodyW/2+2, bodyY+bodyH-7, bodyW-4, 5, 3); fillOnly(c, colors.shirtLo);
  // Collar / neckline
  c.beginPath();
  c.moveTo(-6, bodyY); c.quadraticCurveTo(0, bodyY + 5, 6, bodyY);
  c.strokeStyle = colors.shirtLo; c.lineWidth = 1.5; c.stroke();

  // --- BACK ARM (behind body) ---
  const armW = 10, armH = 22;
  const armY = bodyY + 4;
  if (isHug) {
    // Back arm hangs
    c.beginPath(); rr(c, -bodyW/2-armW+4, armY+1, armW, armH, 5); fillShape(c, colors.shirt);
    c.beginPath(); c.arc(-bodyW/2-armW/2+4, armY+armH+2, 5, 0, Math.PI*2); fillShape(c, colors.skin);
  } else {
    c.save();
    c.translate(-bodyW/2-armW/2+4, armY);
    c.rotate(armSwing * 0.04);
    c.beginPath(); rr(c, -armW/2, 0, armW, armH, 5); fillShape(c, colors.shirt);
    // Elbow highlight
    c.beginPath(); rr(c, -armW/2+2, armH*0.35, armW-4, 4, 2); fillOnly(c, colors.shirtHi);
    // Hand
    c.beginPath(); c.arc(0, armH + 2, 5, 0, Math.PI*2); fillShape(c, colors.skin);
    c.restore();
  }

  // --- FRONT ARM ---
  if (isHug) {
    // Front arm reaches forward
    c.save();
    c.translate(bodyW/2+armW/2-4, armY - 4);
    c.rotate(-0.4); // angled up for hug
    c.beginPath(); rr(c, -armW/2, 0, armW, armH-2, 5); fillShape(c, colors.shirt);
    c.beginPath(); c.arc(0, armH - 2, 5, 0, Math.PI*2); fillShape(c, colors.skin);
    c.restore();
  } else {
    c.save();
    c.translate(bodyW/2+armW/2-4, armY);
    c.rotate(-armSwing * 0.04);
    c.beginPath(); rr(c, -armW/2, 0, armW, armH, 5); fillShape(c, colors.shirt);
    c.beginPath(); rr(c, -armW/2+2, armH*0.35, armW-4, 4, 2); fillOnly(c, colors.shirtHi);
    c.beginPath(); c.arc(0, armH + 2, 5, 0, Math.PI*2); fillShape(c, colors.skin);
    c.restore();
  }

  // --- NECKLACE ---
  c.strokeStyle = '#DAA520'; c.lineWidth = colors.neckW;
  c.beginPath(); c.arc(0, bodyY+4, 10, 0.25, Math.PI-0.25); c.stroke();
  c.fillStyle = '#DAA520'; c.beginPath(); c.arc(0, bodyY+14, 2.5, 0, Math.PI*2); c.fill();

  c.restore(); // undo lean

  return bodyY + bounce; // return bodyY for face positioning
}

// ============================================================
// DRAW LOULOU
// ============================================================
function drawLoulou(c, bx, by, frame, facing, scl, pose) {
  const sc = scl || 1;
  const sprint = player.sprinting && player.moving;
  pose = pose || (player.moving ? 'run' : 'idle');
  c.save();
  c.translate(bx, by);
  c.scale(sc * (facing >= 0 ? 1 : -1), sc);

  // Sprint dust particles
  if (sprint && pose === 'run' && frame % 3 === 0) {
    c.globalAlpha = 0.3;
    c.fillStyle = '#8a7060';
    for (let i = 0; i < 3; i++) {
      const dx = -8 - Math.random() * 12;
      const dy = -2 + Math.random() * 8;
      c.beginPath(); c.arc(dx, dy, 1.5 + Math.random()*2, 0, Math.PI*2); c.fill();
    }
    c.globalAlpha = 1;
  }

  const bodyY = drawBody(c, frame, pose, sprint, {
    shirt: '#1a1a1a', shirtHi: 'rgba(255,255,255,0.06)', shirtLo: 'rgba(255,255,255,0.03)',
    pants: '#222', pantsHi: 'rgba(255,255,255,0.05)',
    shoes: '#111', skin: '#FDDCB5', neckW: 2.5
  });

  drawFace(c, loulouFaceImg, loulouFaceLoaded, bodyY, 50, 16);
  c.restore();
}

// ============================================================
// DRAW ZOUZOU
// ============================================================
function drawZouzou(c, bx, by, frame, facing, scl, pose) {
  const sc = scl || 1;
  pose = pose || (bot.moving ? 'run' : 'idle');
  c.save();
  c.translate(bx, by);
  c.scale(sc * (facing >= 0 ? 1 : -1), sc);

  const bodyY = drawBody(c, frame, pose, false, {
    shirt: '#2E8B57', shirtHi: 'rgba(255,255,255,0.1)', shirtLo: 'rgba(0,60,30,0.15)',
    pants: '#4A6FA5', pantsHi: 'rgba(255,255,255,0.08)',
    shoes: '#C9B896', skin: '#FDDCB5', neckW: 2
  });

  drawFace(c, zouzouFaceImg, zouzouFaceLoaded, bodyY, 48, 16, -3, 4);
  c.restore();
}

// ============================================================
// DRAW HEART SHAPE
// ============================================================
function drawHeart(c, x, y, size, color) {
  c.save();
  c.translate(x, y);
  c.fillStyle = color;
  c.beginPath();
  const s = size;
  c.moveTo(0, s * 0.3);
  c.bezierCurveTo(0, 0, -s, 0, -s, s * 0.35);
  c.bezierCurveTo(-s, s * 0.75, 0, s * 0.95, 0, s * 1.2);
  c.bezierCurveTo(0, s * 0.95, s, s * 0.75, s, s * 0.35);
  c.bezierCurveTo(s, 0, 0, 0, 0, s * 0.3);
  c.fill();
  c.restore();
}

// ============================================================
// HEART PARTICLES
// ============================================================
function spawnHeart(x, y, burst) {
  const angle = Math.random() * Math.PI * 2;
  const speed = burst ? 80 + Math.random() * 160 : 20 + Math.random() * 40;
  const colors = ['#ff4d6d', '#ff6b8a', '#ff8fa3', '#ffb3c6', '#ff1744', '#e91e63'];
  hearts.push({
    x, y,
    vx: Math.cos(angle) * speed,
    vy: Math.sin(angle) * speed - (burst ? 60 : 30),
    size: 4 + Math.random() * 8,
    color: colors[Math.floor(Math.random() * colors.length)],
    life: 1.5 + Math.random() * 1.5,
    maxLife: 2.5,
    rot: Math.random() * Math.PI * 2
  });
}

function updateHearts(dt) {
  for (let i = hearts.length - 1; i >= 0; i--) {
    const h = hearts[i];
    h.x += h.vx * dt;
    h.y += h.vy * dt;
    h.vy += 40 * dt;
    h.life -= dt;
    h.rot += dt * 2;
    if (h.life <= 0) hearts.splice(i, 1);
  }
}

function drawHearts(c) {
  for (const h of hearts) {
    c.save();
    c.globalAlpha = Math.min(1, h.life / 0.5);
    c.translate(h.x, h.y);
    c.rotate(h.rot);
    drawHeart(c, 0, 0, h.size, h.color);
    c.restore();
  }
  c.globalAlpha = 1;
}

// ============================================================
// BACKGROUND
// ============================================================
function initBgHearts() {
  const container = document.getElementById('heartsBg');
  for (let i = 0; i < 15; i++) {
    const h = document.createElement('span');
    h.className = 'heart-float';
    h.textContent = '\u2764';
    h.style.left = Math.random() * 100 + '%';
    h.style.fontSize = (1 + Math.random() * 2) + 'rem';
    h.style.animationDuration = (8 + Math.random() * 12) + 's';
    h.style.animationDelay = (Math.random() * 10) + 's';
    container.appendChild(h);
  }
}

function drawGameBg(c) {
  const grad = c.createLinearGradient(0, 0, 0, H);
  grad.addColorStop(0, '#1e0f28');
  grad.addColorStop(0.5, '#2d1b35');
  grad.addColorStop(1, '#1a0a1e');
  c.fillStyle = grad;
  c.fillRect(0, 0, W, H);
  c.fillStyle = 'rgba(255,107,138,0.03)';
  c.fillRect(0, H * 0.85, W, H * 0.15);
  for (const h of bgHearts) {
    c.save();
    c.globalAlpha = h.alpha;
    drawHeart(c, h.x, h.y, h.size, 'rgba(255,107,138,0.15)');
    c.restore();
  }
  c.globalAlpha = 1;
}

function updateBgHearts(dt) {
  if (bgHearts.length < 8 && Math.random() < dt * 0.5) {
    bgHearts.push({
      x: Math.random() * W, y: H + 20,
      size: 5 + Math.random() * 12,
      speed: 15 + Math.random() * 25,
      alpha: 0.05 + Math.random() * 0.1
    });
  }
  for (let i = bgHearts.length - 1; i >= 0; i--) {
    bgHearts[i].y -= bgHearts[i].speed * dt;
    if (bgHearts[i].y < -30) bgHearts.splice(i, 1);
  }
}

// ============================================================
// LABELS AND SHADOWS
// ============================================================
function drawCharShadow(c, x, y) {
  c.save();
  c.globalAlpha = 0.2;
  c.fillStyle = '#000';
  c.beginPath();
  c.ellipse(x, y + 6, 22, 7, 0, 0, Math.PI * 2);
  c.fill();
  c.restore();
}

function drawLabel(c, x, y, name, color) {
  c.font = 'bold 13px Georgia, serif';
  c.textAlign = 'center';
  c.fillStyle = 'rgba(0,0,0,0.5)';
  c.fillText(name, x + 1, y + 1);
  c.fillStyle = color;
  c.fillText(name, x, y);
}

// ============================================================
// INPUT
// ============================================================
function setupInput() {
  window.addEventListener('keydown', e => {
    keys[e.key.toLowerCase()] = true;
    if (['arrowup', 'arrowdown', 'arrowleft', 'arrowright', ' '].includes(e.key.toLowerCase())) e.preventDefault();
  });
  window.addEventListener('keyup', e => { keys[e.key.toLowerCase()] = false; });
  canvas.addEventListener('touchstart', e => {
    e.preventDefault();
    touchStartX = e.touches[0].clientX;
    touchStartY = e.touches[0].clientY;
    touchActive = true;
    // Double-tap detection for sprint toggle
    const now = Date.now();
    if (now - lastTapTime < 350) {
      touchSprinting = !touchSprinting;
    }
    lastTapTime = now;
  });
  canvas.addEventListener('touchmove', e => {
    e.preventDefault();
    if (!touchActive) return;
    const dx = e.touches[0].clientX - touchStartX;
    const dy = e.touches[0].clientY - touchStartY;
    const d = Math.sqrt(dx * dx + dy * dy);
    if (d > 10) { touchDir.x = dx / d; touchDir.y = dy / d; }
  });
  canvas.addEventListener('touchend', e => {
    e.preventDefault();
    touchActive = false;
    touchDir.x = 0; touchDir.y = 0;
  });
}

function getInputDir() {
  let dx = 0, dy = 0;
  if (keys['w'] || keys['arrowup']) dy -= 1;
  if (keys['s'] || keys['arrowdown']) dy += 1;
  if (keys['a'] || keys['arrowleft']) dx -= 1;
  if (keys['d'] || keys['arrowright']) dx += 1;
  if (touchActive && (touchDir.x || touchDir.y)) { dx = touchDir.x; dy = touchDir.y; }
  const len = Math.sqrt(dx * dx + dy * dy);
  return len > 0 ? { x: dx / len, y: dy / len } : { x: 0, y: 0 };
}

// ============================================================
// BOT AI
// ============================================================
function updateBot(dt) {
  const dx = bot.x - player.x;
  const dy = bot.y - player.y;
  const dist = Math.sqrt(dx * dx + dy * dy);
  const margin = 50;

  bot.pauseTimer -= dt;
  if (!bot.paused && Math.random() < dt * 0.12 && dist > 200) {
    bot.paused = true;
    bot.pauseTimer = 0.3 + Math.random() * 0.6;
  }
  if (bot.paused && bot.pauseTimer <= 0) bot.paused = false;

  if (bot.paused) {
    bot.vx *= 0.9; bot.vy *= 0.9;
    bot.moving = false;
  } else if (dist < 180) {
    const f = dist > 0 ? 1 / dist : 1;
    bot.vx += dx * f * BOT_SPEED * 5 * dt;
    bot.vy += dy * f * BOT_SPEED * 5 * dt;
    bot.moving = true;
  } else {
    bot.changeTimer -= dt;
    if (bot.changeTimer <= 0) {
      const a = Math.atan2(dy, dx) + (Math.random() - 0.5) * 2;
      bot.vx = Math.cos(a) * BOT_SPEED * 0.6;
      bot.vy = Math.sin(a) * BOT_SPEED * 0.6;
      bot.changeTimer = 0.8 + Math.random() * 1.5;
    }
    bot.moving = true;
  }

  const spd = Math.sqrt(bot.vx * bot.vx + bot.vy * bot.vy);
  if (spd > BOT_SPEED) { bot.vx = (bot.vx / spd) * BOT_SPEED; bot.vy = (bot.vy / spd) * BOT_SPEED; }
  bot.vx *= Math.pow(0.02, dt);
  bot.vy *= Math.pow(0.02, dt);
  bot.x += bot.vx * dt;
  bot.y += bot.vy * dt;

  if (bot.x < margin) { bot.x = margin; bot.vx = Math.abs(bot.vx); }
  if (bot.x > W - margin) { bot.x = W - margin; bot.vx = -Math.abs(bot.vx); }
  if (bot.y < margin + 40) { bot.y = margin + 40; bot.vy = Math.abs(bot.vy); }
  if (bot.y > H - margin) { bot.y = H - margin; bot.vy = -Math.abs(bot.vy); }
  if (Math.abs(bot.vx) > 5) bot.facing = bot.vx > 0 ? 1 : -1;
}

// ============================================================
// PLAYER
// ============================================================
function updatePlayer(dt) {
  const dir = getInputDir();
  player.sprinting = keys[' '] || keys['shift'] || touchSprinting;
  const speed = PLAYER_SPEED * (player.sprinting ? SPRINT_MULT : 1);
  player.vx = dir.x * speed;
  player.vy = dir.y * speed;
  player.moving = dir.x !== 0 || dir.y !== 0;
  player.x += player.vx * dt;
  player.y += player.vy * dt;
  const margin = 40;
  player.x = Math.max(margin, Math.min(W - margin, player.x));
  player.y = Math.max(margin + 40, Math.min(H - margin, player.y));
  if (Math.abs(player.vx) > 5) player.facing = player.vx > 0 ? 1 : -1;
}

// ============================================================
// COLLISION
// ============================================================
function checkCatch() {
  const dx = player.x - bot.x;
  const dy = player.y - bot.y;
  return Math.sqrt(dx * dx + dy * dy) < CATCH_DIST;
}

// ============================================================
// CATCH
// ============================================================
function triggerCatch() {
  gameState = 'caught';
  for (let i = 0; i < 50; i++) {
    spawnHeart((player.x + bot.x) / 2, (player.y + bot.y) / 2 - 40, true);
  }
  setTimeout(() => {
    const overlay = document.getElementById('catchOverlay');
    overlay.style.display = 'flex';
    document.getElementById('timerText').textContent = 'Caught in ' + gameTime.toFixed(1) + ' seconds!';
    drawCatchScene();
    // Reset valentine text animation
    const vt = document.getElementById('valentineText');
    vt.style.animation = 'none';
    vt.offsetHeight; // force reflow
    vt.style.animation = '';
    // Spawn heart burst from the valentine text
    spawnHeartBurst();
    requestAnimationFrame(() => overlay.classList.add('visible'));
  }, 1200);
}

function spawnHeartBurst() {
  const container = document.getElementById('heartBurst');
  container.innerHTML = '';
  const emojis = ['\u2764\uFE0F', '\uD83D\uDC96', '\uD83D\uDC97', '\uD83D\uDC95', '\uD83D\uDC9E', '\uD83D\uDC93', '\u2763\uFE0F'];
  const colors = ['#ff4d6d','#ff6b8a','#ff8fa3','#ffb3c6','#ff1744','#e91e63','#ff69b4'];
  for (let i = 0; i < 40; i++) {
    const h = document.createElement('span');
    h.className = 'burst-heart';
    h.textContent = emojis[Math.floor(Math.random() * emojis.length)];
    const angle = (Math.PI * 2 * i / 40) + (Math.random() - 0.5) * 0.5;
    const dist = 80 + Math.random() * 200;
    const tx = Math.cos(angle) * dist;
    const ty = Math.sin(angle) * dist - 40;
    const dur = 1.2 + Math.random() * 1.5;
    const delay = Math.random() * 0.6;
    const size = 0.8 + Math.random() * 1.8;
    h.style.fontSize = size + 'rem';
    h.style.animationDuration = dur + 's';
    h.style.animationDelay = delay + 's';
    h.style.setProperty('--tx', tx + 'px');
    h.style.setProperty('--ty', ty + 'px');
    container.appendChild(h);
  }
  // Second wave
  setTimeout(() => {
    for (let i = 0; i < 25; i++) {
      const h = document.createElement('span');
      h.className = 'burst-heart';
      h.textContent = emojis[Math.floor(Math.random() * emojis.length)];
      const angle = Math.random() * Math.PI * 2;
      const dist = 60 + Math.random() * 250;
      const tx = Math.cos(angle) * dist;
      const ty = Math.sin(angle) * dist - 30;
      const dur = 1 + Math.random() * 1.8;
      const size = 0.6 + Math.random() * 1.5;
      h.style.fontSize = size + 'rem';
      h.style.animationDuration = dur + 's';
      h.style.animationDelay = '0s';
      h.style.setProperty('--tx', tx + 'px');
      h.style.setProperty('--ty', ty + 'px');
      container.appendChild(h);
    }
  }, 800);
}

function drawCatchScene() {
  const cc = catchCtx;
  const cw = catchCanvas.width;
  const ch = catchCanvas.height;
  cc.clearRect(0, 0, cw, ch);
  const cx = cw / 2;
  const cy = ch * 0.8;

  // Draw characters in hug pose, close together
  drawLoulou(cc, cx - 18, cy, 0, 1, 1.3, 'hug');
  drawZouzou(cc, cx + 18, cy, 0, -1, 1.3, 'hug');

  // Floating hearts around the hugging couple
  drawHeart(cc, cx, cy - 130, 18, '#ff4d6d');
  drawHeart(cc, cx - 60, cy - 105, 8, '#ff8fa3');
  drawHeart(cc, cx + 60, cy - 100, 9, '#ffb3c6');
  drawHeart(cc, cx - 45, cy - 130, 6, '#ff6b8a');
  drawHeart(cc, cx + 50, cy - 128, 5, '#ff4d6d');
  drawHeart(cc, cx, cy - 155, 6, '#ffb3c6');
}

// ============================================================
// GAME INIT
// ============================================================
function initGame() {
  canvas = document.getElementById('gameCanvas');
  ctx = canvas.getContext('2d');
  catchCanvas = document.getElementById('catchCanvas');
  catchCtx = catchCanvas.getContext('2d');

  resizeCanvas();
  window.addEventListener('resize', resizeCanvas);
  setupInput();
  initBgHearts();

  document.getElementById('playBtn').addEventListener('click', startGame);
  document.getElementById('replayBtn').addEventListener('click', () => {
    document.getElementById('catchOverlay').classList.remove('visible');
    setTimeout(() => {
      document.getElementById('catchOverlay').style.display = 'none';
      document.getElementById('heartBurst').innerHTML = '';
      startGame();
    }, 600);
  });

  if ('ontouchstart' in window) {
    document.getElementById('instructions').textContent = 'Touch and drag to move ¬∑ Double tap to toggle sprint';
  }
  requestAnimationFrame(gameLoop);
}

function resizeCanvas() {
  W = window.innerWidth;
  H = window.innerHeight;
  canvas.width = W;
  canvas.height = H;
}

function startGame() {
  gameState = 'playing';
  gameTime = 0; frameCount = 0;
  hearts = []; bgHearts = [];
  touchSprinting = false;

  player.x = W * 0.25; player.y = H * 0.55;
  player.vx = 0; player.vy = 0;
  player.facing = 1; player.moving = false;

  bot.x = W * 0.75; bot.y = H * 0.55;
  bot.vx = 0; bot.vy = 0;
  bot.facing = -1; bot.moving = false;
  bot.changeTimer = 1; bot.paused = false; bot.pauseTimer = 0;

  document.getElementById('landing').classList.add('hidden');
  canvas.style.display = 'block';
  document.getElementById('instructions').style.display = 'block';
  document.getElementById('instructions').style.opacity = '1';
  setTimeout(() => {
    document.getElementById('instructions').style.opacity = '0';
  }, 4000);
}

// ============================================================
// GAME LOOP
// ============================================================
function gameLoop(timestamp) {
  const dt = Math.min(0.05, (timestamp - lastTime) / 1000);
  lastTime = timestamp;

  if (gameState === 'playing') {
    gameTime += dt;
    frameCount++;
    updatePlayer(dt);
    updateBot(dt);
    updateBgHearts(dt);
    updateHearts(dt);

    if (bot.moving && frameCount % 25 === 0) {
      spawnHeart(bot.x, bot.y, false);
    }

    if (checkCatch()) triggerCatch();

    drawGameBg(ctx);

    ctx.font = '14px Georgia, serif';
    ctx.textAlign = 'right';
    ctx.fillStyle = 'rgba(255,179,198,0.4)';
    ctx.fillText(gameTime.toFixed(1) + 's', W - 15, 25);

    drawCharShadow(ctx, bot.x, bot.y);
    drawZouzou(ctx, bot.x, bot.y, frameCount, bot.facing);
    drawLabel(ctx, bot.x, bot.y + 18, 'Zouzou', '#ffb3c6');

    drawCharShadow(ctx, player.x, player.y);
    drawLoulou(ctx, player.x, player.y, frameCount, player.facing);
    drawLabel(ctx, player.x, player.y + 18, 'Loulou', '#ff8fa3');

    drawHearts(ctx);
  } else if (gameState === 'caught') {
    updateHearts(dt);
    drawGameBg(ctx);
    drawCharShadow(ctx, bot.x, bot.y);
    drawZouzou(ctx, bot.x, bot.y, 0, bot.facing);
    drawCharShadow(ctx, player.x, player.y);
    drawLoulou(ctx, player.x, player.y, 0, player.facing);
    drawHearts(ctx);
  }

  requestAnimationFrame(gameLoop);
}

window.addEventListener('DOMContentLoaded', initGame);
</script>
</body>
</html>
